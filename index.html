<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internship Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .file-upload {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background-color: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background-color: #f0f4ff;
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #666;
            margin-top: 10px;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9rem;
            display: none;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            transition: border-color 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .table-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:nth-child(even) {
            background-color: #f8f9ff;
        }

        tr:hover {
            background-color: #e8ebff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        .error {
            color: #e74c3c;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
        }

        .sample-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
        }

        .sample-button:hover {
            background: #5a67d8;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üéì Internship Analytics Dashboard</h1>
            <p>Comprehensive insights into student internship data across schools and years</p>
        </div>

        <div class="file-upload">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 2rem; margin-bottom: 10px;">üìÅ</div>
                <div><strong>Click to upload your internship data file</strong></div>
                <div class="upload-text">Supports CSV files (.csv)</div>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            <button class="sample-button" onclick="generateSampleData()">Load Sample Data</button>
            <div id="debugInfo" class="debug-info"></div>
        </div>

        <div class="controls" id="controls" style="display: none;">
            <div class="control-group">
                <label>Filter by Year:</label>
                <select id="yearFilter">
                    <option value="all">All Years</option>
                </select>
            </div>
            <div class="control-group">
                <label>Filter by School:</label>
                <select id="schoolFilter">
                    <option value="all">All Schools</option>
                </select>
            </div>
            <div class="control-group">
                <label>Filter by Degree:</label>
                <select id="degreeFilter">
                    <option value="all">All Degrees</option>
                </select>
            </div>
            <div class="control-group">
                <label>Filter by Sector:</label>
                <select id="sectorFilter">
                    <option value="all">All Sectors</option>
                </select>
            </div>
        </div>

        <div id="dashboardContent" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalEmployers">0</div>
                    <div class="stat-label">Unique Employers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalIndustries">0</div>
                    <div class="stat-label">Industries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSchools">0</div>
                    <div class="stat-label">Schools</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container">
                    <div class="chart-title">Degree Level Distribution by Year</div>
                    <div class="chart-wrapper">
                        <canvas id="degreeByYearChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Distribution by School</div>
                    <div class="chart-wrapper">
                        <canvas id="schoolDistributionChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Students by School Over Time</div>
                    <div class="chart-wrapper">
                        <canvas id="studentsOverTimeChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Sector Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="sectorChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Industry Distribution by School</div>
                    <div class="chart-wrapper">
                        <canvas id="industryBySchoolChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Internship Trends by Sector</div>
                    <div class="chart-wrapper">
                        <canvas id="sectorTrendsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="chart-title">Top Employers by Year</div>
                <div class="table-wrapper">
                    <table id="employersTable">
                        <thead>
                            <tr>
                                <th>Employer Name</th>
                                <th>Industry</th>
                                <th>Student Count</th>
                                <th>Primary School</th>
                                <th>Sector</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let internshipData = [];
        let charts = {};

        // Debug function
        function debugLog(message) {
            console.log(message);
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = 'block';
            debugInfo.innerHTML += message + '<br>';
        }

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.querySelector('.upload-area');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                debugLog('File dropped: ' + files[0].name);
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            debugLog('File input changed');
            if (e.target.files.length > 0) {
                debugLog('File selected: ' + e.target.files[0].name);
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            debugLog('Handling file: ' + file.name + ', size: ' + file.size + ' bytes');
            
            // Check if Papa Parse is available
            if (typeof Papa === 'undefined') {
                debugLog('Papa Parse library not loaded');
                showError('CSV parsing library not loaded. Please refresh the page and try again.');
                return;
            }
            
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                debugLog('Parsing CSV file...');
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        debugLog('CSV parsing complete. Rows: ' + results.data.length);
                        debugLog('Sample headers: ' + Object.keys(results.data[0] || {}).join(', '));
                        if (results.errors.length > 0) {
                            debugLog('Parsing errors: ' + JSON.stringify(results.errors));
                        }
                        processData(results.data);
                    },
                    error: function(error) {
                        debugLog('CSV parsing error: ' + error.message);
                        showError('Error parsing CSV: ' + error.message);
                    }
                });
            } else {
                debugLog('Invalid file type: ' + fileName);
                showError('Please upload a CSV file (.csv)');
            }
        }

        function processData(data) {
            debugLog('Processing data... Raw rows: ' + data.length);
            
            // First, let's see what the actual headers look like
            if (data.length > 0) {
                debugLog('Raw headers found: [' + Object.keys(data[0]).map(h => '"' + h + '"').join(', ') + ']');
            }
            
            // Clean and process the data
            internshipData = data.map(row => {
                // Clean the data - first clean the keys
                const cleanRow = {};
                Object.keys(row).forEach(key => {
                    const cleanKey = key.trim();
                    cleanRow[cleanKey] = row[key] ? row[key].toString().trim() : '';
                });
                
                // Extract year from semester
                if (cleanRow['Semester']) {
                    const semesterMatch = cleanRow['Semester'].match(/(\d{4})/);
                    cleanRow['Year'] = semesterMatch ? semesterMatch[1] : '';
                }
                
                return cleanRow;
            }).filter(row => {
                // Now filter for rows with student names - check multiple possible column names
                const studentNameVariations = ['Student Name', 'StudentName', 'student name', 'Name'];
                let hasStudentName = false;
                
                for (let variation of studentNameVariations) {
                    if (row[variation] && row[variation].toString().trim() !== '') {
                        hasStudentName = true;
                        break;
                    }
                }
                
                return hasStudentName;
            });

            debugLog('Processed data rows: ' + internshipData.length);
            
            if (internshipData.length === 0) {
                debugLog('No valid data found');
                debugLog('Looking for Student Name variations. Check if your column is named differently.');
                if (data.length > 0) {
                    debugLog('Available columns: ' + Object.keys(data[0]).join(', '));
                }
                showError('No valid data found. Please check that your CSV has a "Student Name" column with data. Available columns: ' + (data.length > 0 ? Object.keys(data[0]).join(', ') : 'None'));
                return;
            }

            debugLog('Sample processed row: ' + JSON.stringify(internshipData[0]));
            showSuccess('Successfully loaded ' + internshipData.length + ' records!');
            
            try {
                setupFilters();
                debugLog('Filters setup completed');
            } catch (e) {
                debugLog('Error setting up filters: ' + e.message);
                showError('Error setting up filters: ' + e.message);
                return;
            }
            
            try {
                updateDashboard();
                debugLog('Dashboard update completed');
            } catch (e) {
                debugLog('Error updating dashboard: ' + e.message);
                showError('Error updating dashboard: ' + e.message);
                return;
            }
            
            // Show the dashboard
            debugLog('Showing controls and dashboard content');
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('dashboardContent').style.display = 'block';
            debugLog('Dashboard should now be visible');
        }

        function setupFilters() {
            debugLog('Setting up filters...');
            
            const years = [...new Set(internshipData.map(d => d.Year).filter(y => y))].sort();
            const schools = [...new Set(internshipData.map(d => d.School).filter(s => s))].sort();
            const degrees = [...new Set(internshipData.map(d => d['U/G/D']).filter(d => d))].sort();
            const sectors = [...new Set(internshipData.map(d => d.Sector).filter(s => s))].sort();

            debugLog('Years: ' + years.join(', '));
            debugLog('Schools: ' + schools.join(', '));
            debugLog('Degrees: ' + degrees.join(', '));
            debugLog('Sectors: ' + sectors.join(', '));

            populateSelect('yearFilter', years);
            populateSelect('schoolFilter', schools);
            populateSelect('degreeFilter', degrees);
            populateSelect('sectorFilter', sectors);

            // Add event listeners
            ['yearFilter', 'schoolFilter', 'degreeFilter', 'sectorFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateDashboard);
            });
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Clear existing options except "All"
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            options.forEach(option => {
                if (option) {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    select.appendChild(optionElement);
                }
            });
            
            select.value = currentValue;
        }

        function getFilteredData() {
            const yearFilter = document.getElementById('yearFilter').value;
            const schoolFilter = document.getElementById('schoolFilter').value;
            const degreeFilter = document.getElementById('degreeFilter').value;
            const sectorFilter = document.getElementById('sectorFilter').value;

            return internshipData.filter(d => {
                return (yearFilter === 'all' || d.Year === yearFilter) &&
                       (schoolFilter === 'all' || d.School === schoolFilter) &&
                       (degreeFilter === 'all' || d['U/G/D'] === degreeFilter) &&
                       (sectorFilter === 'all' || d.Sector === sectorFilter);
            });
        }

        function updateDashboard() {
            const filteredData = getFilteredData();
            debugLog('Updating dashboard with ' + filteredData.length + ' filtered records');
            
            try {
                updateStats(filteredData);
                debugLog('Stats updated successfully');
            } catch (e) {
                debugLog('Error updating stats: ' + e.message);
            }
            
            try {
                updateCharts(filteredData);
                debugLog('Charts updated successfully');
            } catch (e) {
                debugLog('Error updating charts: ' + e.message);
            }
            
            try {
                updateEmployersTable(filteredData);
                debugLog('Employers table updated successfully');
            } catch (e) {
                debugLog('Error updating employers table: ' + e.message);
            }
        }

        function updateStats(data) {
            const totalStudents = data.length;
            const totalEmployers = new Set(data.map(d => d['Employer Name']).filter(e => e)).size;
            const totalIndustries = new Set(data.map(d => d['Employer Industry/Type']).filter(i => i)).size;
            const totalSchools = new Set(data.map(d => d.School).filter(s => s)).size;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalEmployers').textContent = totalEmployers;
            document.getElementById('totalIndustries').textContent = totalIndustries;
            document.getElementById('totalSchools').textContent = totalSchools;
        }

        function updateCharts(data) {
            debugLog('Starting chart updates...');
            
            try {
                updateDegreeByYearChart(data);
                debugLog('Degree by year chart updated');
            } catch (e) {
                debugLog('Error updating degree by year chart: ' + e.message);
            }
            
            try {
                updateSchoolDistributionChart(data);
                debugLog('School distribution chart updated');
            } catch (e) {
                debugLog('Error updating school distribution chart: ' + e.message);
            }
            
            try {
                updateStudentsOverTimeChart(data);
                debugLog('Students over time chart updated');
            } catch (e) {
                debugLog('Error updating students over time chart: ' + e.message);
            }
            
            try {
                updateSectorChart(data);
                debugLog('Sector chart updated');
            } catch (e) {
                debugLog('Error updating sector chart: ' + e.message);
            }
            
            try {
                updateIndustryBySchoolChart(data);
                debugLog('Industry by school chart updated');
            } catch (e) {
                debugLog('Error updating industry by school chart: ' + e.message);
            }
            
            try {
                updateSectorTrendsChart(data);
                debugLog('Sector trends chart updated');
            } catch (e) {
                debugLog('Error updating sector trends chart: ' + e.message);
            }
        }

        function updateDegreeByYearChart(data) {
            const ctx = document.getElementById('degreeByYearChart').getContext('2d');
            
            if (charts.degreeByYear) {
                charts.degreeByYear.destroy();
            }

            const years = [...new Set(data.map(d => d.Year).filter(y => y))].sort();
            const degrees = ['U', 'G', 'D'];
            const degreeLabels = { 'U': 'Undergraduate', 'G': 'Graduate', 'D': 'Doctoral' };

            const datasets = degrees.map((degree, index) => {
                const colors = ['#FF6384', '#36A2EB', '#FFCE56'];
                return {
                    label: degreeLabels[degree],
                    data: years.map(year => 
                        data.filter(d => d.Year === year && d['U/G/D'] === degree).length
                    ),
                    backgroundColor: colors[index],
                    borderColor: colors[index],
                    borderWidth: 2
                };
            });

            charts.degreeByYear = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateSchoolDistributionChart(data) {
            const ctx = document.getElementById('schoolDistributionChart').getContext('2d');
            
            if (charts.schoolDistribution) {
                charts.schoolDistribution.destroy();
            }

            const schoolCounts = {};
            data.forEach(d => {
                if (d.School) {
                    schoolCounts[d.School] = (schoolCounts[d.School] || 0) + 1;
                }
            });

            const sortedSchools = Object.entries(schoolCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            charts.schoolDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedSchools.map(([school]) => school),
                    datasets: [{
                        data: sortedSchools.map(([,count]) => count),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateStudentsOverTimeChart(data) {
            const ctx = document.getElementById('studentsOverTimeChart').getContext('2d');
            
            if (charts.studentsOverTime) {
                charts.studentsOverTime.destroy();
            }

            const yearFilter = document.getElementById('yearFilter').value;
            const schoolFilter = document.getElementById('schoolFilter').value;
            
            let chartTitle = 'Students by School Over Time';
            let chartType = 'line';
            let years, schools, datasets;
            
            if (yearFilter !== 'all') {
                // Single year selected - show bar chart
                chartType = 'bar';
                chartTitle = `Students by School - ${yearFilter}`;
                
                if (schoolFilter === 'all') {
                    // Show all schools for the selected year
                    const schoolCounts = {};
                    data.filter(d => d.Year === yearFilter).forEach(d => {
                        if (d.School) {
                            schoolCounts[d.School] = (schoolCounts[d.School] || 0) + 1;
                        }
                    });
                    
                    const sortedSchools = Object.entries(schoolCounts)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 10);
                    
                    datasets = [{
                        label: 'Students',
                        data: sortedSchools.map(([,count]) => count),
                        backgroundColor: '#36A2EB',
                        borderColor: '#36A2EB',
                        borderWidth: 2
                    }];
                    
                    charts.studentsOverTime = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: sortedSchools.map(([school]) => school),
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 45
                                    }
                                },
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } else {
                    // Show only selected school for the selected year
                    const count = data.filter(d => d.Year === yearFilter && d.School === schoolFilter).length;
                    
                    datasets = [{
                        label: 'Students',
                        data: [count],
                        backgroundColor: '#36A2EB',
                        borderColor: '#36A2EB',
                        borderWidth: 2
                    }];
                    
                    charts.studentsOverTime = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: [schoolFilter],
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } else {
                // Multiple years - show line chart
                years = [...new Set(data.map(d => d.Year).filter(y => y))].sort();
                
                if (schoolFilter === 'all') {
                    // Show top 5 schools when no filter is applied
                    schools = [...new Set(data.map(d => d.School).filter(s => s))].slice(0, 5);
                    chartTitle = 'Students by School Over Time';
                } else {
                    // Show only the selected school
                    schools = [schoolFilter];
                    chartTitle = `Students Over Time - ${schoolFilter}`;
                }
                
                datasets = schools.map((school, index) => {
                    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
                    return {
                        label: school,
                        data: years.map(year => 
                            data.filter(d => d.Year === year && d.School === school).length
                        ),
                        borderColor: colors[index],
                        backgroundColor: colors[index] + '20',
                        tension: 0.1
                    };
                });

                charts.studentsOverTime = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Update chart title
            try {
                const titleElement = document.querySelector('#studentsOverTimeChart').closest('.chart-container').querySelector('.chart-title');
                if (titleElement) {
                    titleElement.textContent = chartTitle;
                }
            } catch (e) {
                debugLog('Error updating chart title: ' + e.message);
            }
        }

        function updateSectorChart(data) {
            const ctx = document.getElementById('sectorChart').getContext('2d');
            
            if (charts.sector) {
                charts.sector.destroy();
            }

            const sectorCounts = {};
            data.forEach(d => {
                if (d.Sector) {
                    sectorCounts[d.Sector] = (sectorCounts[d.Sector] || 0) + 1;
                }
            });

            charts.sector = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(sectorCounts),
                    datasets: [{
                        data: Object.values(sectorCounts),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateIndustryBySchoolChart(data) {
            const ctx = document.getElementById('industryBySchoolChart').getContext('2d');
            
            if (charts.industryBySchool) {
                charts.industryBySchool.destroy();
            }

            const schoolFilter = document.getElementById('schoolFilter').value;
            const sectorFilter = document.getElementById('sectorFilter').value;
            
            let schools, chartTitle;
            
            if (schoolFilter === 'all') {
                // Show top 4 schools when no filter is applied
                schools = [...new Set(data.map(d => d.School).filter(s => s))].slice(0, 4);
                chartTitle = 'Industry Distribution by School';
            } else {
                // Show only the selected school
                schools = [schoolFilter];
                chartTitle = `Industry Distribution - ${schoolFilter}`;
            }
            
            // Get industries from filtered data
            let industries;
            if (sectorFilter === 'all') {
                industries = [...new Set(data.map(d => d['Employer Industry/Type']).filter(i => i))].slice(0, 8);
            } else {
                // If sector is filtered, show industries within that sector
                industries = [...new Set(data.filter(d => d.Sector === sectorFilter).map(d => d['Employer Industry/Type']).filter(i => i))].slice(0, 8);
            }

            const datasets = schools.map((school, index) => {
                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'];
                return {
                    label: school,
                    data: industries.map(industry => 
                        data.filter(d => d.School === school && d['Employer Industry/Type'] === industry).length
                    ),
                    backgroundColor: colors[index],
                    borderColor: colors[index],
                    borderWidth: 1
                };
            });

            // Update chart title safely
            try {
                const titleElement = document.querySelector('#industryBySchoolChart').closest('.chart-container').querySelector('.chart-title');
                if (titleElement) {
                    titleElement.textContent = chartTitle;
                }
            } catch (e) {
                debugLog('Error updating chart title: ' + e.message);
            }

            charts.industryBySchool = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: industries,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateSectorTrendsChart(data) {
            const ctx = document.getElementById('sectorTrendsChart').getContext('2d');
            
            if (charts.sectorTrends) {
                charts.sectorTrends.destroy();
            }

            const yearFilter = document.getElementById('yearFilter').value;
            const sectorFilter = document.getElementById('sectorFilter').value;
            const schoolFilter = document.getElementById('schoolFilter').value;
            
            let years = [...new Set(data.map(d => d.Year).filter(y => y))].sort();
            let sectors, chartTitle;
            
            // Determine which sectors to show and chart title
            if (sectorFilter === 'all') {
                // Show all sectors
                sectors = [...new Set(data.map(d => d.Sector).filter(s => s))];
                if (schoolFilter === 'all') {
                    if (yearFilter === 'all') {
                        chartTitle = 'Internship Trends by Sector';
                    } else {
                        chartTitle = `Internship Trends by Sector - ${yearFilter}`;
                    }
                } else {
                    if (yearFilter === 'all') {
                        chartTitle = `Internship Trends by Sector - ${schoolFilter}`;
                    } else {
                        chartTitle = `Internship Trends by Sector - ${schoolFilter} (${yearFilter})`;
                    }
                }
            } else {
                // Show only the selected sector
                sectors = [sectorFilter];
                if (schoolFilter === 'all') {
                    if (yearFilter === 'all') {
                        chartTitle = `Internship Trends - ${sectorFilter} Sector`;
                    } else {
                        chartTitle = `Internship Trends - ${sectorFilter} Sector (${yearFilter})`;
                    }
                } else {
                    if (yearFilter === 'all') {
                        chartTitle = `Internship Trends - ${sectorFilter} Sector (${schoolFilter})`;
                    } else {
                        chartTitle = `Internship Trends - ${sectorFilter} Sector (${schoolFilter}, ${yearFilter})`;
                    }
                }
            }

            // If a specific year is selected, show bar chart instead of line chart
            if (yearFilter !== 'all') {
                // Show bar chart for single year
                const sectorCounts = {};
                data.filter(d => d.Year === yearFilter).forEach(d => {
                    if (d.Sector && sectors.includes(d.Sector)) {
                        sectorCounts[d.Sector] = (sectorCounts[d.Sector] || 0) + 1;
                    }
                });

                const sortedSectors = Object.entries(sectorCounts)
                    .sort(([,a], [,b]) => b - a);

                charts.sectorTrends = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedSectors.map(([sector]) => sector),
                        datasets: [{
                            label: 'Students',
                            data: sortedSectors.map(([,count]) => count),
                            backgroundColor: '#36A2EB',
                            borderColor: '#36A2EB',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                // Show line chart for multiple years
                const datasets = sectors.map((sector, index) => {
                    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
                    return {
                        label: sector,
                        data: years.map(year => 
                            data.filter(d => d.Year === year && d.Sector === sector).length
                        ),
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        tension: 0.1
                    };
                });

                charts.sectorTrends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Update chart title
            try {
                const titleElement = document.querySelector('#sectorTrendsChart').closest('.chart-container').querySelector('.chart-title');
                if (titleElement) {
                    titleElement.textContent = chartTitle;
                }
            } catch (e) {
                debugLog('Error updating chart title: ' + e.message);
            }
        }

        function updateEmployersTable(data) {
            const employerCounts = {};
            
            data.forEach(d => {
                if (d['Employer Name']) {
                    const key = d['Employer Name'];
                    if (!employerCounts[key]) {
                        employerCounts[key] = {
                            name: d['Employer Name'],
                            industry: d['Employer Industry/Type'] || 'N/A',
                            count: 0,
                            schools: new Set(),
                            sector: d.Sector || 'N/A'
                        };
                    }
                    employerCounts[key].count++;
                    if (d.School) employerCounts[key].schools.add(d.School);
                }
            });

            const sortedEmployers = Object.values(employerCounts)
                .sort((a, b) => b.count - a.count)
                .slice(0, 20);

            const tbody = document.querySelector('#employersTable tbody');
            tbody.innerHTML = '';

            sortedEmployers.forEach(employer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employer.name}</td>
                    <td>${employer.industry}</td>
                    <td>${employer.count}</td>
                    <td>${Array.from(employer.schools).slice(0, 2).join(', ')}</td>
                    <td>${employer.sector}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = '<strong>Error:</strong> ' + message;
            document.querySelector('.dashboard-container').appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 8000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = '<strong>Success:</strong> ' + message;
            document.querySelector('.dashboard-container').appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // Generate sample data for demonstration
        function generateSampleData() {
            debugLog('Generating sample data...');
            
            // Check if Papa Parse is available
            if (typeof Papa === 'undefined') {
                debugLog('Papa Parse library not loaded');
                showError('CSV parsing library not loaded. Please refresh the page and try again.');
                return;
            }
            
            const sampleData = `Student Name,GWID,Semester,School,Employer Name,Employer Industry/Type,U/G/D,Sector
John Doe,G12345678,FALL 2020,SEAS,Google,Technology,G,Private
Jane Smith,G23456789,SPRING 2021,CCAS,World Bank,International Development,U,Public
Bob Johnson,G34567890,FALL 2021,ESIA,Microsoft,Technology,D,Private
Alice Brown,G45678901,SPRING 2022,SEAS,Amazon,Technology,G,Private
Charlie Wilson,G56789012,FALL 2022,CCAS,United Nations,International Development,U,Public
David Lee,G67890123,SPRING 2020,GWSB,JPMorgan Chase,Financial Services,G,Private
Emma Davis,G78901234,FALL 2023,SEAS,Apple,Technology,U,Private
Frank Miller,G89012345,SPRING 2023,ESIA,State Department,Government,G,Public
Grace Taylor,G90123456,FALL 2022,CCAS,McKinsey & Company,Consulting,D,Private
Henry Clark,G01234567,SPRING 2021,GWSB,Goldman Sachs,Financial Services,G,Private
Ivy Rodriguez,G11234568,FALL 2023,SEAS,Meta,Technology,U,Private
Jack Anderson,G22345679,SPRING 2022,ESIA,World Health Organization,International Development,G,Public
Kate Thompson,G33456780,FALL 2021,CCAS,Deloitte,Consulting,U,Private
Leo Martinez,G44567891,SPRING 2023,GWSB,Bank of America,Financial Services,D,Private
Maya Singh,G55678902,FALL 2020,SEAS,Tesla,Technology,G,Private
Nina Patel,G66789013,SPRING 2021,CCAS,Accenture,Consulting,U,Private
Oscar Chen,G77890124,FALL 2022,ESIA,USAID,International Development,G,Public
Paula Rivera,G88901235,SPRING 2020,GWSB,Morgan Stanley,Financial Services,D,Private
Quinn Foster,G99012346,FALL 2023,SEAS,IBM,Technology,U,Private
Rachel Green,G10123457,SPRING 2022,CCAS,Boston Consulting Group,Consulting,G,Private
Sam Turner,G21234568,FALL 2021,ESIA,Department of Defense,Government,U,Public
Tina Wu,G32345679,SPRING 2023,GWSB,Citigroup,Financial Services,G,Private
Uma Gupta,G43456790,FALL 2020,SEAS,Netflix,Technology,D,Private
Victor Hayes,G54567801,SPRING 2021,CCAS,PwC,Consulting,U,Private
Wendy Kim,G65678912,FALL 2022,ESIA,Peace Corps,International Development,G,Public`;

            Papa.parse(sampleData, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    debugLog('Sample data parsed successfully');
                    processData(results.data);
                },
                error: function(error) {
                    debugLog('Sample data parsing error: ' + error.message);
                    showError('Error generating sample data: ' + error.message);
                }
            });
        }

        // Clear debug info when new file is uploaded
        fileInput.addEventListener('change', () => {
            document.getElementById('debugInfo').innerHTML = '';
            document.getElementById('debugInfo').style.display = 'none';
        });

        // Check if libraries are loaded when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof Papa === 'undefined') {
                    showError('CSV parsing library failed to load. Please refresh the page.');
                    debugLog('Papa Parse library not available after page load');
                } else {
                    debugLog('Papa Parse library loaded successfully');
                }
                
                if (typeof Chart === 'undefined') {
                    showError('Chart library failed to load. Please refresh the page.');
                    debugLog('Chart.js library not available after page load');
                } else {
                    debugLog('Chart.js library loaded successfully');
                }
            }, 1000);
        });
    </script>
</body>
</html>
                            